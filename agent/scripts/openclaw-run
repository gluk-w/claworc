#!/usr/bin/with-contenv bash

# Initialize config if missing
if [ ! -f "/config/.openclaw/openclaw.json" ]; then
    echo "Initializing OpenClaw..."
    mkdir -p /config/.openclaw
    # doctor might return non-zero if fixes are applied? ignore exit code
    echo "Running doctor..."
    openclaw doctor --fix || echo "Doctor finished with exit code $?"
    
    openclaw config set gateway.mode local
    openclaw config set gateway.bind lan
    openclaw config set gateway.controlUi.dangerouslyDisableDeviceAuth true
    if [ -f "/config/browser.json" ]; then
        openclaw config set browser "$(cat /config/browser.json)" --json
    fi
fi

# Set token if provided
if [ -n "$OPENCLAW_GATEWAY_TOKEN" ]; then
    openclaw config set gateway.auth.token "$OPENCLAW_GATEWAY_TOKEN"
fi

# Ensure claworc owns the config directory
chown -R claworc:claworc /config/.openclaw

echo "Starting OpenClaw Gateway (foreground) as claworc..."
# OpenClaw requires an open stdin stream or it exits.
exec bash -c "tail -f /dev/null | s6-setuidgid claworc /usr/bin/openclaw gateway run"
